#include <assert.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include <libopencmsis/core_cm3.h>

#include "util.h"
#include "wifi.h"

// wifi_rb is the ring buffer that receives all incoming data from the WIFI
// module, data is written to it during an interrupt on the USART and read from
// it in the wifi sys tick handler.
uint8_t wifi_rb_space[RING_BUFF_SIZE];
ring_buffer_t wifi_rb = {wifi_rb_space, 0, 0, 0};

// tmp_buffer is used to process WIND from the WIFI module.
uint8_t tmp_buffer[WIFI_TMP_BUFF_SIZE];

static void wifi_SetupGPIO(void);
static void wifi_SetupUSART(void);

bool wifi_ProcessCIND(Config *c, uint8_t *const buff);
static uint16_t httpStatus(uint8_t *response);

unsigned char index_html[];
unsigned int index_html_len;
unsigned char json_header[];

// wifi_Init boots the WIFI module.
void wifi_Init(void) {
  wifi_SetupGPIO();
  wifi_SetupUSART();
  spwf_Init();
}

// Implement SPWF01SX hardware communication functions.
void spwfDelay(uint32_t ms) { delay(ms); }
void spwf_PowerOn(void) { gpio_set(GPIOB, GPIO2); }
void spwf_PowerOff(void) { gpio_clear(GPIOB, GPIO2); }
void spwf_Send(char data) { usart_send_blocking(WIFI_USART, data); }
void spwf_DebugSend(char data) { usart_send_blocking(DEBUG_USART, data); }

// wifi_SetupGPIO configures the GPIOs for settings up the USART.
static void wifi_SetupGPIO(void) {
  rcc_periph_clock_enable(RCC_WIFI_USART);

  gpio_mode_setup(WIFI_GPIO_PORT, GPIO_MODE_AF, GPIO_PUPD_NONE, WIFI_GPIO_TX);
  gpio_set_output_options(WIFI_GPIO_PORT, GPIO_OTYPE_PP, GPIO_OSPEED_10MHZ,
                          WIFI_GPIO_TX);

  gpio_mode_setup(WIFI_GPIO_PORT, GPIO_MODE_AF, GPIO_PUPD_NONE, WIFI_GPIO_RX);
  gpio_set_output_options(WIFI_GPIO_PORT, GPIO_OTYPE_PP, GPIO_OSPEED_10MHZ,
                          WIFI_GPIO_RX);

  gpio_set_af(WIFI_GPIO_PORT, GPIO_AF7, WIFI_GPIO_TX);
  gpio_set_af(WIFI_GPIO_PORT, GPIO_AF7, WIFI_GPIO_RX);
}

// wifi_SetupUSART configures the USART for communicating with the WIFI module.
static void wifi_SetupUSART(void) {
  usart_set_baudrate(WIFI_USART, 115200);
  usart_set_databits(WIFI_USART, 8);
  usart_set_stopbits(WIFI_USART, USART_STOPBITS_1);
  usart_set_mode(WIFI_USART, USART_MODE_TX_RX);
  usart_set_parity(WIFI_USART, USART_PARITY_NONE);
  usart_set_flow_control(WIFI_USART, USART_FLOWCONTROL_NONE);

  nvic_enable_irq(WIFI_NVIC_IRQ);

  // Give lower priority to SYSTICK IRQ than to WIFI USART IRQ so that we can
  // keep pushing data into the ring buffer even when wifi_SysTickHandler is
  // processing.
  nvic_set_priority(NVIC_SYSTICK_IRQ, (1 << 4));
  nvic_set_priority(WIFI_NVIC_IRQ, (0 << 4));

  usart_enable_rx_interrupt(WIFI_USART);

  usart_enable(WIFI_USART);
}

// wifi_SysTickHandler consumes the wifi ring buffer and processes it according
// to the current spwf_RecvState. Only one char is processed per tick, except
// when AT_STATUS_FAST_PROCESS is enabled.
void wifi_SysTickHandler(void) {
  uint8_t data;
  bool status;

process_loop:
  // Temporarily disable interrupts, ring buffer is not thread safe.
  __disable_irq();
  data = ring_buffer_pop(&wifi_rb);
  __enable_irq();

  if (data != '\0') {
    switch (spwf_RecvState) {
      // Asynchronous indications can happen at any point except when an AT
      // command is processing, this is the default spwf_RecvState.
      case RECV_ASYNC_INDICATION:
        status = spwf_ProcessAsyncIndication(&tmp_buffer[0], data);

        if (status == SPWF_PROCESS_COMPLETE) {
          bool is_wind = spwf_ProcessWIND(&spwf_State, &tmp_buffer[0]);

          if (!is_wind && !wifi_ProcessCIND(&config, &tmp_buffer[0])) {
            printf("Could not process asynchronous indication\n");
          }

          memset(&tmp_buffer[0], 0, WIFI_TMP_BUFF_SIZE);
        }

        break;
      // AT command responses only happen after an AT command has been issued,
      // some only return OK / ERROR whereas others have a response body, ending
      // with OK / ERROR.
      case RECV_AT_RESPONSE:
        status = spwf_ProcessATResponse(&spwf_ATState, data);
        if (status == SPWF_PROCESS_COMPLETE) {
          spwf_RecvState = RECV_ASYNC_INDICATION;
        } else if ((spwf_ATState.status & AT_STATUS_FAST_PROCESS) != 0) {
          goto process_loop;
        }
        break;
      // Unhandled recv state.
      default:
        printf("Unknown spwf_RecvState\n");
        break;
    }
  }
}

// WIFI_ISR handles interrupts from the WIFI module and stores the data in a
// ring buffer.
void WIFI_ISR(void) {
  if (usart_get_flag(WIFI_USART, USART_SR_RXNE)) {
    uint8_t data;
    data = usart_recv(WIFI_USART);

    // Temporarily disable interrupts, ring buffer is not thread safe.
    __disable_irq();
    ring_buffer_push(&wifi_rb, data);
    __enable_irq();
  }
}

// wifi_ProcessCIND consumes a buffer containing CIND (custom indication) and
// enables remote management of the bttn.
bool wifi_ProcessCIND(Config *c, uint8_t *const buff_ptr) {
  static char text[120];
  CINDType n = CIND_UNDEF;
  char *cind_ptr;

  cind_ptr = strstr((const char *)buff_ptr, "+CIND:");
  if (cind_ptr) {
    cind_ptr += 6;  // Skip over "+CIND:", next char is a digit.

    // We assume the indication ID is never greater than 99 (two digits).
    n = *cind_ptr++ - '0';  // Convert char to int
    if (*cind_ptr != ':') {
      n *= 10;                 // First digit was a multiple of 10
      n += *cind_ptr++ - '0';  // Convert char to int
    }

    cind_ptr++;  // Skip over ':', leaving message.
  }

  switch (n) {
    case CIND_COMMIT_CONFIG:
      conf_RequestCommit(c);
      break;
    case CIND_SET_URL1:
      memset(&text[0], 0, 120);
      url_decode(&text[0], cind_ptr, URL_LENGTH);
      printf("Set URL1 to %s!\n", &text[0]);
      conf_Set(c, CONF_URL1, &text[0]);
      break;
    case CIND_SET_URL2:
      memset(&text[0], 0, 120);
      url_decode(&text[0], cind_ptr, URL_LENGTH);
      printf("Set URL2 to %s!\n", &text[0]);
      conf_Set(c, CONF_URL2, &text[0]);
      break;
    case CIND_UNDEF:
      return false;
      break;
  }

  return true;
}

// wifi_HTTPGet performs a blocking HTTP GET request and returns the http status
// code returned by the server.
uint16_t wifi_HTTPGet(char *url) {
  char req[URL_LENGTH];

  assert(strlen(url) <= URL_LENGTH);

  sprintf(&req[0], "AT+S.HTTPGET=%s", url);
  spwf_ATCmd(&req[0]);

  // We use fast processing here to quickly receive the response.
  spwf_ATState.status |= AT_STATUS_FAST_PROCESS;

  spwf_ATCmdWait();

  if ((spwf_ATState.status & AT_STATUS_OK) != 0) {
    return httpStatus(spwf_ATState.buff);
  } else {
    return 0;
  }
}

// httpStatus takes a http response buffer and tries to parse the
// status code from the http header, zero is returned when no status is found.
static uint16_t httpStatus(uint8_t *response) {
  uint16_t status = 0;
  char status_str[3];
  char *header_ptr;

  header_ptr = strstr((const char *)response, "HTTP/1.");
  if (header_ptr) {
    // The status code is the 9th-11th element of the header.
    // Example: "HTTP/1.0 200 OK"
    memcpy(&status_str, (header_ptr + 9), 3);
    status = atoi(&status_str[0]);
  }

  return status;
}

void wifi_GetSSID(char *dest, size_t len) {
  char *s;

  assert(len >= 32);

  spwf_ATCmdBlocking("AT+S.GCFG=wifi_ssid");

  s = strstr((const char *)spwf_ATState.buff, "#  wifi_ssid = ");
  if (s) {
    s += 15;  // Skip over "#  wifi_ssid = ".
    int i;
    for (i = 0; i < 32 && isxdigit(*s); i++) {  // Max lenght is 32.
      dest[i] = strtol(s, &s, 16);
      if (*s == ':') {
        s++;
      }
    }
  }
}

void wifi_CreateOpenBTTNPage(void) {
  char atCmd[26];  // AT+S.FSC=/index.html,0000\0

  memset(&atCmd[0], 0, sizeof(atCmd) / sizeof(atCmd[0]));
  snprintf(&atCmd[0], sizeof(atCmd) / sizeof(atCmd[0]),
           "AT+S.FSC=/index.html,%d", (int)index_html_len);

  printf("Sending: %s\n", atCmd);
  spwf_ATCmdBlocking(&atCmd[0]);  // Create file (AT+S.FSC).

  atCmd[7] = 'A';         // Modify command (AT+S.FSC -> AT+S.FSA).
  spwf_ATCmd(&atCmd[0]);  // Append to file.

  spwf_SendString((const char *)&index_html[0]);

  // Wait for response from WIFI module.
  spwf_ATCmdWait();
}

void wifi_StoreConfigJSON(ConfigData *data) {
  const char *url1 = (const char *)&data->url1[0];
  const char *url2 = (const char *)&data->url2[0];
  uint16_t len = strlen((const char *)&json_header[0]) + strlen(url1) +
                 strlen(url2) + 21;  // 21 = {"url1":"","url2":""}

  spwf_ATCmdBlocking("AT+S.FSD=/config.json");

  char atCmd[27];  // AT+S.FSC=/config.json,0000\0
  memset(&atCmd[0], 0, sizeof(atCmd) / sizeof(atCmd[0]));
  snprintf(atCmd, sizeof(atCmd) / sizeof(atCmd[0]), "AT+S.FSC=/config.json,%d",
           len);

  spwf_ATCmdBlocking(&atCmd[0]);  // Create file (AT+S.FSC).

  atCmd[7] = 'A';         // Modify command (AT+S.FSC -> AT+S.FSA).
  spwf_ATCmd(&atCmd[0]);  // Append to file.

  spwf_SendString((const char *)&json_header[0]);

  // Send file contents.
  spwf_SendString("{\"url1\":\"");
  spwf_SendString(url1);
  spwf_SendString("\",\"url2\":\"");
  spwf_SendString(url2);
  spwf_SendString("\"}");

  spwf_ATCmdWait();  // Wait for file to be created.
}

unsigned char index_html[] = {
    0x48, 0x54, 0x54, 0x50, 0x2f, 0x31, 0x2e, 0x30, 0x20, 0x32, 0x30, 0x30,
    0x20, 0x4f, 0x4b, 0x0a, 0x53, 0x65, 0x72, 0x76, 0x65, 0x72, 0x3a, 0x20,
    0x4f, 0x70, 0x65, 0x6e, 0x42, 0x54, 0x54, 0x4e, 0x0a, 0x43, 0x6f, 0x6e,
    0x6e, 0x65, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x3a, 0x20, 0x63, 0x6c, 0x6f,
    0x73, 0x65, 0x0a, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x2d, 0x54,
    0x79, 0x70, 0x65, 0x3a, 0x20, 0x74, 0x65, 0x78, 0x74, 0x2f, 0x68, 0x74,
    0x6d, 0x6c, 0x0a, 0x43, 0x6f, 0x6e, 0x74, 0x65, 0x6e, 0x74, 0x2d, 0x4c,
    0x65, 0x6e, 0x67, 0x74, 0x68, 0x3a, 0x20, 0x31, 0x37, 0x33, 0x31, 0x0a,
    0x0a, 0x0a, 0x3c, 0x21, 0x44, 0x4f, 0x43, 0x54, 0x59, 0x50, 0x45, 0x20,
    0x68, 0x74, 0x6d, 0x6c, 0x3e, 0x0a, 0x3c, 0x68, 0x74, 0x6d, 0x6c, 0x3e,
    0x0a, 0x3c, 0x68, 0x65, 0x61, 0x64, 0x3e, 0x0a, 0x09, 0x3c, 0x74, 0x69,
    0x74, 0x6c, 0x65, 0x3e, 0x4f, 0x70, 0x65, 0x6e, 0x42, 0x54, 0x54, 0x4e,
    0x3c, 0x2f, 0x74, 0x69, 0x74, 0x6c, 0x65, 0x3e, 0x0a, 0x3c, 0x2f, 0x68,
    0x65, 0x61, 0x64, 0x3e, 0x0a, 0x3c, 0x62, 0x6f, 0x64, 0x79, 0x3e, 0x0a,
    0x09, 0x3c, 0x68, 0x31, 0x3e, 0x4f, 0x70, 0x65, 0x6e, 0x42, 0x54, 0x54,
    0x4e, 0x3c, 0x2f, 0x68, 0x31, 0x3e, 0x0a, 0x09, 0x3c, 0x66, 0x6f, 0x72,
    0x6d, 0x3e, 0x0a, 0x09, 0x09, 0x55, 0x52, 0x4c, 0x3a, 0x3c, 0x62, 0x72,
    0x3e, 0x0a, 0x09, 0x09, 0x3c, 0x69, 0x6e, 0x70, 0x75, 0x74, 0x20, 0x69,
    0x64, 0x3d, 0x22, 0x75, 0x72, 0x6c, 0x31, 0x22, 0x20, 0x76, 0x61, 0x6c,
    0x75, 0x65, 0x3d, 0x22, 0x68, 0x74, 0x74, 0x70, 0x3a, 0x2f, 0x2f, 0x22,
    0x3e, 0x3c, 0x62, 0x72, 0x3e, 0x20, 0x4c, 0x6f, 0x6e, 0x67, 0x20, 0x70,
    0x72, 0x65, 0x73, 0x73, 0x20, 0x55, 0x52, 0x4c, 0x3a, 0x3c, 0x62, 0x72,
    0x3e, 0x0a, 0x09, 0x09, 0x3c, 0x69, 0x6e, 0x70, 0x75, 0x74, 0x20, 0x69,
    0x64, 0x3d, 0x22, 0x75, 0x72, 0x6c, 0x32, 0x22, 0x20, 0x76, 0x61, 0x6c,
    0x75, 0x65, 0x3d, 0x22, 0x68, 0x74, 0x74, 0x70, 0x3a, 0x2f, 0x2f, 0x22,
    0x3e, 0x3c, 0x62, 0x72, 0x3e, 0x0a, 0x09, 0x09, 0x3c, 0x69, 0x6e, 0x70,
    0x75, 0x74, 0x20, 0x69, 0x64, 0x3d, 0x22, 0x61, 0x70, 0x70, 0x6c, 0x79,
    0x22, 0x20, 0x74, 0x79, 0x70, 0x65, 0x3d, 0x22, 0x62, 0x75, 0x74, 0x74,
    0x6f, 0x6e, 0x22, 0x20, 0x76, 0x61, 0x6c, 0x75, 0x65, 0x3d, 0x22, 0x41,
    0x70, 0x70, 0x6c, 0x79, 0x20, 0x28, 0x4d, 0x65, 0x6d, 0x6f, 0x72, 0x79,
    0x29, 0x22, 0x3e, 0x20, 0x3c, 0x69, 0x6e, 0x70, 0x75, 0x74, 0x20, 0x69,
    0x64, 0x3d, 0x22, 0x63, 0x6f, 0x6d, 0x6d, 0x69, 0x74, 0x22, 0x20, 0x74,
    0x79, 0x70, 0x65, 0x3d, 0x22, 0x62, 0x75, 0x74, 0x74, 0x6f, 0x6e, 0x22,
    0x20, 0x76, 0x61, 0x6c, 0x75, 0x65, 0x3d, 0x22, 0x43, 0x6f, 0x6d, 0x6d,
    0x69, 0x74, 0x20, 0x28, 0x45, 0x45, 0x50, 0x52, 0x4f, 0x4d, 0x29, 0x22,
    0x3e, 0x0a, 0x09, 0x3c, 0x2f, 0x66, 0x6f, 0x72, 0x6d, 0x3e, 0x0a, 0x09,
    0x3c, 0x73, 0x63, 0x72, 0x69, 0x70, 0x74, 0x3e, 0x27, 0x75, 0x73, 0x65,
    0x20, 0x73, 0x74, 0x72, 0x69, 0x63, 0x74, 0x27, 0x3b, 0x63, 0x6f, 0x6e,
    0x73, 0x74, 0x20, 0x75, 0x72, 0x6c, 0x3d, 0x27, 0x2f, 0x6f, 0x75, 0x74,
    0x70, 0x75, 0x74, 0x2e, 0x63, 0x67, 0x69, 0x3f, 0x74, 0x65, 0x78, 0x74,
    0x3d, 0x27, 0x3b, 0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x70, 0x61, 0x72,
    0x73, 0x65, 0x72, 0x3d, 0x64, 0x6f, 0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74,
    0x2e, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x45, 0x6c, 0x65, 0x6d, 0x65,
    0x6e, 0x74, 0x28, 0x27, 0x61, 0x27, 0x29, 0x3b, 0x66, 0x65, 0x74, 0x63,
    0x68, 0x28, 0x27, 0x2e, 0x2f, 0x63, 0x6f, 0x6e, 0x66, 0x69, 0x67, 0x2e,
    0x6a, 0x73, 0x6f, 0x6e, 0x27, 0x29, 0x2e, 0x74, 0x68, 0x65, 0x6e, 0x28,
    0x72, 0x3d, 0x3e, 0x72, 0x2e, 0x6a, 0x73, 0x6f, 0x6e, 0x28, 0x29, 0x29,
    0x2e, 0x74, 0x68, 0x65, 0x6e, 0x28, 0x73, 0x3d, 0x3e, 0x7b, 0x66, 0x6f,
    0x72, 0x28, 0x6c, 0x65, 0x74, 0x20, 0x6b, 0x65, 0x79, 0x20, 0x69, 0x6e,
    0x20, 0x73, 0x29, 0x7b, 0x64, 0x6f, 0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74,
    0x2e, 0x67, 0x65, 0x74, 0x45, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x42,
    0x79, 0x49, 0x64, 0x28, 0x6b, 0x65, 0x79, 0x29, 0x2e, 0x76, 0x61, 0x6c,
    0x75, 0x65, 0x3d, 0x64, 0x65, 0x63, 0x6f, 0x64, 0x65, 0x41, 0x54, 0x55,
    0x52, 0x4c, 0x28, 0x73, 0x5b, 0x6b, 0x65, 0x79, 0x5d, 0x29, 0x7d, 0x7d,
    0x29, 0x3b, 0x64, 0x6f, 0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74, 0x2e, 0x61,
    0x64, 0x64, 0x45, 0x76, 0x65, 0x6e, 0x74, 0x4c, 0x69, 0x73, 0x74, 0x65,
    0x6e, 0x65, 0x72, 0x28, 0x27, 0x44, 0x4f, 0x4d, 0x43, 0x6f, 0x6e, 0x74,
    0x65, 0x6e, 0x74, 0x4c, 0x6f, 0x61, 0x64, 0x65, 0x64, 0x27, 0x2c, 0x28,
    0x29, 0x3d, 0x3e, 0x7b, 0x64, 0x6f, 0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74,
    0x2e, 0x67, 0x65, 0x74, 0x45, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x42,
    0x79, 0x49, 0x64, 0x28, 0x27, 0x61, 0x70, 0x70, 0x6c, 0x79, 0x27, 0x29,
    0x2e, 0x61, 0x64, 0x64, 0x45, 0x76, 0x65, 0x6e, 0x74, 0x4c, 0x69, 0x73,
    0x74, 0x65, 0x6e, 0x65, 0x72, 0x28, 0x27, 0x63, 0x6c, 0x69, 0x63, 0x6b,
    0x27, 0x2c, 0x63, 0x6c, 0x69, 0x63, 0x6b, 0x28, 0x66, 0x61, 0x6c, 0x73,
    0x65, 0x29, 0x29, 0x3b, 0x64, 0x6f, 0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74,
    0x2e, 0x67, 0x65, 0x74, 0x45, 0x6c, 0x65, 0x6d, 0x65, 0x6e, 0x74, 0x42,
    0x79, 0x49, 0x64, 0x28, 0x27, 0x63, 0x6f, 0x6d, 0x6d, 0x69, 0x74, 0x27,
    0x29, 0x2e, 0x61, 0x64, 0x64, 0x45, 0x76, 0x65, 0x6e, 0x74, 0x4c, 0x69,
    0x73, 0x74, 0x65, 0x6e, 0x65, 0x72, 0x28, 0x27, 0x63, 0x6c, 0x69, 0x63,
    0x6b, 0x27, 0x2c, 0x63, 0x6c, 0x69, 0x63, 0x6b, 0x28, 0x74, 0x72, 0x75,
    0x65, 0x29, 0x29, 0x3b, 0x66, 0x75, 0x6e, 0x63, 0x74, 0x69, 0x6f, 0x6e,
    0x20, 0x63, 0x6c, 0x69, 0x63, 0x6b, 0x28, 0x63, 0x6f, 0x6d, 0x6d, 0x69,
    0x74, 0x43, 0x68, 0x61, 0x6e, 0x67, 0x65, 0x73, 0x29, 0x7b, 0x72, 0x65,
    0x74, 0x75, 0x72, 0x6e, 0x20, 0x65, 0x3d, 0x3e, 0x7b, 0x65, 0x2e, 0x70,
    0x72, 0x65, 0x76, 0x65, 0x6e, 0x74, 0x44, 0x65, 0x66, 0x61, 0x75, 0x6c,
    0x74, 0x28, 0x29, 0x3b, 0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x75, 0x72,
    0x6c, 0x31, 0x3d, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x43, 0x49, 0x4e,
    0x44, 0x28, 0x31, 0x2c, 0x61, 0x74, 0x55, 0x52, 0x4c, 0x28, 0x64, 0x6f,
    0x63, 0x75, 0x6d, 0x65, 0x6e, 0x74, 0x2e, 0x67, 0x65, 0x74, 0x45, 0x6c,
    0x65, 0x6d, 0x65, 0x6e, 0x74, 0x42, 0x79, 0x49, 0x64, 0x28, 0x27, 0x75,
    0x72, 0x6c, 0x31, 0x27, 0x29, 0x2e, 0x76, 0x61, 0x6c, 0x75, 0x65, 0x29,
    0x29, 0x3b, 0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x75, 0x72, 0x6c, 0x32,
    0x3d, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x43, 0x49, 0x4e, 0x44, 0x28,
    0x32, 0x2c, 0x61, 0x74, 0x55, 0x52, 0x4c, 0x28, 0x64, 0x6f, 0x63, 0x75,
    0x6d, 0x65, 0x6e, 0x74, 0x2e, 0x67, 0x65, 0x74, 0x45, 0x6c, 0x65, 0x6d,
    0x65, 0x6e, 0x74, 0x42, 0x79, 0x49, 0x64, 0x28, 0x27, 0x75, 0x72, 0x6c,
    0x32, 0x27, 0x29, 0x2e, 0x76, 0x61, 0x6c, 0x75, 0x65, 0x29, 0x29, 0x3b,
    0x63, 0x6f, 0x6e, 0x73, 0x74, 0x20, 0x63, 0x6f, 0x6d, 0x6d, 0x69, 0x74,
    0x3d, 0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x43, 0x49, 0x4e, 0x44, 0x28,
    0x30, 0x2c, 0x27, 0x43, 0x6f, 0x6d, 0x6d, 0x69, 0x74, 0x20, 0x63, 0x6f,
    0x6e, 0x66, 0x69, 0x67, 0x75, 0x72, 0x61, 0x74, 0x69, 0x6f, 0x6e, 0x27,
    0x29, 0x3b, 0x66, 0x65, 0x74, 0x63, 0x68, 0x28, 0x75, 0x72, 0x6c, 0x31,
    0x29, 0x2e, 0x74, 0x68, 0x65, 0x6e, 0x28, 0x28, 0x29, 0x3d, 0x3e, 0x66,
    0x65, 0x74, 0x63, 0x68, 0x28, 0x75, 0x72, 0x6c, 0x32, 0x29, 0x29, 0x2e,
    0x74, 0x68, 0x65, 0x6e, 0x28, 0x28, 0x29, 0x3d, 0x3e, 0x63, 0x6f, 0x6d,
    0x6d, 0x69, 0x74, 0x43, 0x68, 0x61, 0x6e, 0x67, 0x65, 0x73, 0x3f, 0x66,
    0x65, 0x74, 0x63, 0x68, 0x28, 0x63, 0x6f, 0x6d, 0x6d, 0x69, 0x74, 0x29,
    0x3a, 0x27, 0x27, 0x29, 0x2e, 0x74, 0x68, 0x65, 0x6e, 0x28, 0x28, 0x29,
    0x3d, 0x3e, 0x63, 0x6f, 0x6e, 0x73, 0x6f, 0x6c, 0x65, 0x2e, 0x6c, 0x6f,
    0x67, 0x28, 0x27, 0x53, 0x61, 0x76, 0x65, 0x64, 0x21, 0x27, 0x29, 0x29,
    0x2e, 0x63, 0x61, 0x74, 0x63, 0x68, 0x28, 0x72, 0x3d, 0x3e, 0x63, 0x6f,
    0x6e, 0x73, 0x6f, 0x6c, 0x65, 0x2e, 0x6c, 0x6f, 0x67, 0x28, 0x72, 0x29,
    0x29, 0x7d, 0x7d, 0x7d, 0x29, 0x3b, 0x66, 0x75, 0x6e, 0x63, 0x74, 0x69,
    0x6f, 0x6e, 0x20, 0x61, 0x74, 0x55, 0x52, 0x4c, 0x28, 0x75, 0x72, 0x6c,
    0x29, 0x7b, 0x69, 0x66, 0x28, 0x21, 0x75, 0x72, 0x6c, 0x2e, 0x6d, 0x61,
    0x74, 0x63, 0x68, 0x28, 0x2f, 0x5e, 0x68, 0x74, 0x74, 0x70, 0x73, 0x3f,
    0x3a, 0x5c, 0x2f, 0x5c, 0x2f, 0x2f, 0x29, 0x29, 0x7b, 0x75, 0x72, 0x6c,
    0x3d, 0x27, 0x68, 0x74, 0x74, 0x70, 0x3a, 0x2f, 0x2f, 0x27, 0x2b, 0x75,
    0x72, 0x6c, 0x7d, 0x70, 0x61, 0x72, 0x73, 0x65, 0x72, 0x2e, 0x68, 0x72,
    0x65, 0x66, 0x3d, 0x75, 0x72, 0x6c, 0x3b, 0x6c, 0x65, 0x74, 0x20, 0x70,
    0x6f, 0x72, 0x74, 0x3d, 0x70, 0x61, 0x72, 0x73, 0x65, 0x72, 0x2e, 0x70,
    0x6f, 0x72, 0x74, 0x3b, 0x69, 0x66, 0x28, 0x70, 0x61, 0x72, 0x73, 0x65,
    0x72, 0x2e, 0x70, 0x72, 0x6f, 0x74, 0x6f, 0x63, 0x6f, 0x6c, 0x3d, 0x3d,
    0x3d, 0x27, 0x68, 0x74, 0x74, 0x70, 0x73, 0x3a, 0x27, 0x26, 0x26, 0x21,
    0x70, 0x6f, 0x72, 0x74, 0x29, 0x7b, 0x70, 0x6f, 0x72, 0x74, 0x3d, 0x34,
    0x34, 0x33, 0x7d, 0x6c, 0x65, 0x74, 0x20, 0x6e, 0x65, 0x77, 0x55, 0x52,
    0x4c, 0x3d, 0x60, 0x24, 0x7b, 0x70, 0x61, 0x72, 0x73, 0x65, 0x72, 0x2e,
    0x68, 0x6f, 0x73, 0x74, 0x6e, 0x61, 0x6d, 0x65, 0x7d, 0x2c, 0x24, 0x7b,
    0x70, 0x61, 0x72, 0x73, 0x65, 0x72, 0x2e, 0x70, 0x61, 0x74, 0x68, 0x6e,
    0x61, 0x6d, 0x65, 0x7d, 0x24, 0x7b, 0x70, 0x61, 0x72, 0x73, 0x65, 0x72,
    0x2e, 0x73, 0x65, 0x61, 0x72, 0x63, 0x68, 0x7d, 0x2c, 0x24, 0x7b, 0x70,
    0x6f, 0x72, 0x74, 0x7d, 0x60, 0x3b, 0x69, 0x66, 0x28, 0x6e, 0x65, 0x77,
    0x55, 0x52, 0x4c, 0x2e, 0x6c, 0x65, 0x6e, 0x67, 0x74, 0x68, 0x3e, 0x31,
    0x30, 0x30, 0x29, 0x7b, 0x74, 0x68, 0x72, 0x6f, 0x77, 0x20, 0x6e, 0x65,
    0x77, 0x20, 0x45, 0x72, 0x72, 0x6f, 0x72, 0x28, 0x27, 0x6d, 0x61, 0x78,
    0x20, 0x6c, 0x65, 0x6e, 0x67, 0x74, 0x68, 0x27, 0x29, 0x7d, 0x72, 0x65,
    0x74, 0x75, 0x72, 0x6e, 0x20, 0x6e, 0x65, 0x77, 0x55, 0x52, 0x4c, 0x7d,
    0x66, 0x75, 0x6e, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x20, 0x64, 0x65, 0x63,
    0x6f, 0x64, 0x65, 0x41, 0x54, 0x55, 0x52, 0x4c, 0x28, 0x75, 0x72, 0x6c,
    0x29, 0x7b, 0x6c, 0x65, 0x74, 0x5b, 0x64, 0x6f, 0x6d, 0x61, 0x69, 0x6e,
    0x2c, 0x73, 0x65, 0x61, 0x72, 0x63, 0x68, 0x2c, 0x70, 0x6f, 0x72, 0x74,
    0x5d, 0x3d, 0x75, 0x72, 0x6c, 0x2e, 0x73, 0x70, 0x6c, 0x69, 0x74, 0x28,
    0x27, 0x2c, 0x27, 0x29, 0x3b, 0x69, 0x66, 0x28, 0x70, 0x6f, 0x72, 0x74,
    0x29, 0x7b, 0x70, 0x6f, 0x72, 0x74, 0x3d, 0x27, 0x3a, 0x27, 0x2b, 0x70,
    0x6f, 0x72, 0x74, 0x7d, 0x72, 0x65, 0x74, 0x75, 0x72, 0x6e, 0x27, 0x68,
    0x74, 0x74, 0x70, 0x3a, 0x2f, 0x2f, 0x27, 0x2b, 0x64, 0x6f, 0x6d, 0x61,
    0x69, 0x6e, 0x2b, 0x70, 0x6f, 0x72, 0x74, 0x2b, 0x73, 0x65, 0x61, 0x72,
    0x63, 0x68, 0x7d, 0x66, 0x75, 0x6e, 0x63, 0x74, 0x69, 0x6f, 0x6e, 0x20,
    0x63, 0x72, 0x65, 0x61, 0x74, 0x65, 0x43, 0x49, 0x4e, 0x44, 0x28, 0x69,
    0x64, 0x2c, 0x74, 0x65, 0x78, 0x74, 0x29, 0x7b, 0x63, 0x6f, 0x6e, 0x73,
    0x74, 0x20, 0x63, 0x69, 0x6e, 0x64, 0x3d, 0x60, 0x2b, 0x43, 0x49, 0x4e,
    0x44, 0x3a, 0x24, 0x7b, 0x69, 0x64, 0x7d, 0x3a, 0x24, 0x7b, 0x65, 0x6e,
    0x63, 0x6f, 0x64, 0x65, 0x55, 0x52, 0x49, 0x43, 0x6f, 0x6d, 0x70, 0x6f,
    0x6e, 0x65, 0x6e, 0x74, 0x28, 0x74, 0x65, 0x78, 0x74, 0x29, 0x7d, 0x60,
    0x3b, 0x69, 0x66, 0x28, 0x63, 0x69, 0x6e, 0x64, 0x2e, 0x6c, 0x65, 0x6e,
    0x67, 0x74, 0x68, 0x3e, 0x31, 0x32, 0x30, 0x29, 0x7b, 0x74, 0x68, 0x72,
    0x6f, 0x77, 0x20, 0x6e, 0x65, 0x77, 0x20, 0x45, 0x72, 0x72, 0x6f, 0x72,
    0x28, 0x27, 0x6d, 0x61, 0x78, 0x20, 0x65, 0x6e, 0x63, 0x6f, 0x64, 0x65,
    0x64, 0x20, 0x6c, 0x65, 0x6e, 0x67, 0x74, 0x68, 0x27, 0x29, 0x7d, 0x72,
    0x65, 0x74, 0x75, 0x72, 0x6e, 0x20, 0x75, 0x72, 0x6c, 0x2b, 0x63, 0x69,
    0x6e, 0x64, 0x7d, 0x3c, 0x2f, 0x73, 0x63, 0x72, 0x69, 0x70, 0x74, 0x3e,
    0x0a, 0x3c, 0x2f, 0x62, 0x6f, 0x64, 0x79, 0x3e, 0x0a, 0x3c, 0x2f, 0x68,
    0x74, 0x6d, 0x6c, 0x3e, 0x0a};
unsigned int index_html_len = 1829;

unsigned char json_header[] =
    "HTTP/1.0 200 OK\n"
    "Server: OpenBTTN\n"
    "Connection: close\n"
    "Content-Type: application/json\n\n\n";
